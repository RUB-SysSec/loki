# Loki Obfuscator

In this subdirectory, you will find everything needed to use Loki to obfuscate functions. This directory's structure is as follows:

## Dependencies: z3
Run `install_z3.sh` to install the required version of z3

## Translator
Our C++ componenet responsible for lifting the initial binary and translating it to a format our custom obfuscator can understand. Additionally, it is responsbile for re-translation of the obfuscated code to an executable. We require a specific LLVM version (which will have been built and is available at /llvm if using our Docker image). In either case, you need a symlink called `llvm` pointing to the root of the built LLVM project. Then, you need to build the translator by running its `build.sh`.

## Obfuscator
Our Rust component responsible for transforming the to-be-protected code. Make sure to build this component using `cargo build --release`.

## Testcases
A directory containing test cases for obfuscation. The `obfuscate.py` script, which is a convenience wrapper we recommend you use, will pull its targets from there.

## Other
This directory has two additional scripts:
* `build.sh`: This script will build all required components.
* `obfuscate.py`: This script will generate obfuscated binaries. 


# Usage
Use the obfuscate.py script as follows:
```
python3 obfuscate.py --allow aes_encrypt --instances 2 ~/evaluation/test
```
This will generate two different obfuscated instances of AES at ~/evaluation/test. The structure of the generated directory is heavily geared towards evaluation purposes and as follows:
```
/home/user/evaluation/test
├── bin                         # binaries/data from translator component
│   ├── generate-vm-9.0         # used to generate an executable from our IL
│   ├── lift_input              # used to initially lift a function to our custom IL
│   └── template.bc             # template bytecode into which the function is inserted
├── documentation.txt           # some diagnostics data (config used, branches etc)
├── obfuscate.log               # logfile of obfuscate.py
└── workdirs                    # each selected test case has an own subfolder here
    └── aes_encrypt
        ├── bin
        │   ├── orig_exe        # original, non-obfuscated binary
        │   └── vm_alu          # Rust obfuscator
        ├── instances           # generated obfuscated binaries
        │   ├── vm_alu000               # first obfuscated instance
        │   │   ├── byte_code.bin       # bytecode which is inserted into the binary
        │   │   ├── debug_files         # debug files
        │   │   │   └── byte_code.txt   # for example, human-readable bytecode
        │   │   ├── obf_exe             # obfuscated binary
        │   │   ├── timings.txt         # timings measured during building
        │   │   └── variable_map.txt    # obfuscator-internal data (needed for compilation)
        │   └── vm_alu001               # second obfuscated instance
        │       ├── byte_code.bin
        │       ├── debug_files
        │       │   └── byte_code.txt
        │       ├── obf_exe
        │       ├── timings.txt
        │       └── variable_map.txt
        └── src                         # source code
            ├── input_program.bc        # bytecode of the input program
            ├── input_program.cpp       # source code of the input program
            ├── input_program_opt.bc    # optimized bytecode (~O3)
            ├── input_program_opt.ll    # human-readable version of byte-code
            └── lifted_input.txt        # output generated by the lifting stage of our translator

10 directories, 22 files
```

